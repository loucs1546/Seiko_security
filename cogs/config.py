# cogs/config.py
import discord
from discord.ext import commands
import core_config as config

class ConfigCog(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @discord.app_commands.command(name="config", description="Interface de configuration avanc√©e")
    async def config(self, interaction: discord.Interaction):
        if not interaction.user.guild_permissions.administrator:
            await interaction.response.send_message("‚ùå R√©serv√© aux administrateurs.", ephemeral=True)
            return

        embed = self.get_security_embed()
        view = SecurityConfigView(self.bot)
        await interaction.response.send_message(embed=embed, view=view, ephemeral=True)

    def get_security_embed(self):
        anti_spam = config.CONFIG["security"]["anti_spam"]
        anti_raid = config.CONFIG["security"]["anti_raid"]
        anti_hack = config.CONFIG["security"]["anti_hack"]

        status = {True: "‚úÖ **Activ√©**", False: "‚ùå **D√©sactiv√©**"}

        embed = discord.Embed(
            title="üõ°Ô∏è Configuration de la S√©curit√©",
            description="Cliquez sur les boutons pour basculer l'√©tat.",
            color=0x2ecc71,
            timestamp=discord.utils.utcnow()
        )
        embed.add_field(name="ü§ñ Anti-Spam", value=status[anti_spam], inline=False)
        embed.add_field(name="üë• Anti-Raid", value=status[anti_raid], inline=False)
        embed.add_field(name="üïµÔ∏è Anti-Hack", value=status[anti_hack], inline=False)
        embed.set_footer(text="CyberWatch ‚Ä¢ S√©curit√© en temps r√©el")
        return embed

class SecurityConfigView(discord.ui.View):
    def __init__(self, bot):
        super().__init__(timeout=600)
        self.bot = bot

    async def toggle_and_run(self, interaction: discord.Interaction, setting: str, command_name: str):
        current = config.CONFIG["security"][setting]
        new_value = not current
        config.CONFIG["security"][setting] = new_value

        # Appeler la commande r√©elle
        cog = self.bot.get_cog("ModerationCommandsCog")
        if cog:
            cmd = getattr(cog, command_name, None)
            if cmd:
                # Cr√©er une fausse interaction avec le bool√©en
                class FakeInteraction:
                    def __init__(self, orig, val):
                        self._orig = orig
                        self.value = val
                    def __getattr__(self, name):
                        return getattr(self._orig, name)
                    async def response(self):
                        return self
                    async def send_message(self, *args, **kwargs):
                        pass
                    async def defer(self, **kwargs):
                        pass

                fake = FakeInteraction(interaction, new_value)
                await cmd(fake)

        # Mettre √† jour l'embed
        embed = ConfigCog(self.bot).get_security_embed()
        await interaction.response.edit_message(embed=embed, view=self)

    @discord.ui.button(label="Anti-Spam", emoji="ü§ñ", style=discord.ButtonStyle.secondary)
    async def anti_spam_btn(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.toggle_and_run(interaction, "anti_spam", "anti_spam")

    @discord.ui.button(label="Anti-Raid", emoji="üë•", style=discord.ButtonStyle.secondary)
    async def anti_raid_btn(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.toggle_and_run(interaction, "anti_raid", "anti_raid")

    @discord.ui.button(label="Anti-Hack", emoji="üïµÔ∏è", style=discord.ButtonStyle.secondary)
    async def anti_hack_btn(self, interaction: discord.Interaction, button: discord.ui.Button):
        await self.toggle_and_run(interaction, "anti_hack", "anti_hack")

async def setup(bot):
    await bot.add_cog(ConfigCog(bot))